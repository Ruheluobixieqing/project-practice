# Java Spring Boot CI Pipeline
name: Java CI with Maven

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ°mainåˆ†æ”¯æˆ–åˆ›å»ºPRæ—¶
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# å®šä¹‰ä»»åŠ¡
jobs:
  test:
    # è¿è¡Œç¯å¢ƒ
    # ubuntu-latest: Linuxç¯å¢ƒï¼ˆæ¨èï¼Œé€Ÿåº¦å—ï¼‰
    # windows-latest: Windowsç¯å¢ƒ
    # macos-latest: macOSç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    # 2. è®¾ç½®Javaç¯å¢ƒ
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    # 3. ç¼“å­˜Mavenä¾èµ–ï¼ˆæé«˜æ„å»ºé€Ÿåº¦ï¼‰
    - name: ğŸ“¦ Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    # 4. ç¼–è¯‘é¡¹ç›®
    - name: ğŸ”§ Compile project
      run: |
        cd backend
        mvn clean compile
    
    # 5. è¿è¡Œæµ‹è¯•
    - name: ğŸ§ª Run tests
      run: |
        cd backend
        mvn test
    
    # 6. æ„å»ºé¡¹ç›®
    - name: ğŸ“¦ Build project
      run: |
        cd backend
        mvn package -DskipTests
    
    # 7. ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šï¼ˆå³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿä¼šæ‰§è¡Œï¼‰
    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: backend/target/surefire-reports/
    
    # 8. ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: ğŸ“¤ Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifact
        path: backend/target/*.jar

  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
  code-quality:
    runs-on: ubuntu-latest
    needs: test  # ä¾èµ–testä»»åŠ¡å®Œæˆ
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    # æ£€æŸ¥ä»£ç æ ¼å¼
    - name: ğŸ¨ Check code style
      run: |
        cd backend
        mvn compile
        echo "âœ… Code compilation successful"
    
    # ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
    - name: ğŸ“ˆ Generate test coverage
      run: |
        cd backend
        mvn test jacoco:report
    
    # ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
    - name: ğŸ“Š Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: backend/target/site/jacoco/
